---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';

export const prerender = true;
const projects = await getCollection('projects');
const sortedProjects = projects.sort((a, b) => {
    const orderA = a.data.order || 999;
    const orderB = b.data.order || 999;
    return orderA - orderB;
});

// Собираем уникальные категории и технологии
const categories = [...new Set(projects.map(p => p.data.projectLabel))];
const allTech = projects.flatMap(p => p.data.techStack.map(t => t.name));
const technologies = [...new Set(allTech)].sort();

// Фильтруем только крупные фреймворки и языки
const majorTech = ['Laravel', 'Go', 'Next.js', 'React', 'Vue.js', 'Node.js', 'TypeScript', 'JavaScript', 'Python', 'PHP', 'Astro', 'Nuxt', 'Angular', 'Svelte', 'Django', 'FastAPI'];
const filteredTechnologies = technologies.filter(tech => 
    majorTech.some(major => tech.toLowerCase().includes(major.toLowerCase()))
).sort();
---

<BaseLayout 
    title="Все проекты — Антон Двинянинов"
    description="Портфолио проектов: веб-разработка, UI/UX дизайн, SaaS-платформы и веб-приложения"
>
    <link slot="head" rel="stylesheet" href="/styles/projects.css">
    <Header />
    
    <main class="projects-page">
        <div class="projects-hero">
            <a href="/" class="back-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                <span>На главную</span>
            </a>
            
            <div class="projects-hero__content">
                <span class="projects-hero__label">Портфолио</span>
                <h1 class="projects-hero__title">Все проекты</h1>
                <p class="projects-hero__desc">
                    Веб-разработка, UI/UX дизайн и создание цифровых продуктов
                </p>
            </div>
        </div>
        
        <div class="projects-container">
            <section class="projects-grid-section">
                <div class="projects-list" id="projectsList">
                    {sortedProjects.map((project, index) => (
                        <article class="project-item" data-type={project.data.projectType} data-category={project.data.projectLabel} data-client={project.data.projectClient} data-year={project.data.projectYear} data-tech={project.data.techStack.map(t => t.name).join(',')}>
                            <a href={`/projects/${project.slug}/`} class="project-item__link">
                                <div class="project-item__image">
                                    {project.data.projectImage ? (
                                        <img 
                                            src={project.data.projectImage} 
                                            alt={project.data.projectName} 
                                            class="project-item__photo"
                                            loading={index === 0 ? "eager" : "lazy"}
                                            decoding="async"
                                            width="180"
                                            height="180"
                                        />
                                    ) : project.data.projectLogo ? (
                                        <img 
                                            src={project.data.projectLogo} 
                                            alt={`${project.data.projectName} logo`} 
                                            class="project-item__logo"
                                            loading={index === 0 ? "eager" : "lazy"}
                                            decoding="async"
                                            width="180"
                                            height="180"
                                        />
                                    ) : (
                                        <div class="project-item__placeholder">
                                            {project.data.projectName.charAt(0)}
                                        </div>
                                    )}
                                </div>
                                
                                <div class="project-item__content">
                                    <div class="project-item__header">
                                        <h2 class="project-item__title">{project.data.projectName}</h2>
                                        <span class="project-item__label">{project.data.projectLabel}</span>
                                    </div>
                                    <p class="project-item__desc">{project.data.projectDesc}</p>
                                    <div class="project-item__tech">
                                        {project.data.techStack.slice(0, 6).map(tech => (
                                            <img src={tech.icon} alt={tech.name} class="tech-icon" title={tech.name} />
                                        ))}
                                        {project.data.techStack.length > 6 && (
                                            <span class="tech-more">+{project.data.techStack.length - 6}</span>
                                        )}
                                    </div>
                                </div>
                                
                                <div class="project-item__arrow">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M5 12h14M12 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </a>
                        </article>
                    ))}
                </div>
            </section>
            
            <aside class="projects-sidebar">
                <div class="projects-sidebar__sticky">
                    <div class="filter-card">
                        <div class="filter-card__header">
                            <h3 class="filter-card__title">Фильтры</h3>
                            <button class="filter-reset" id="resetFilters">Сбросить</button>
                        </div>
                        
                        <div class="filter-group">
                            <h4 class="filter-group__title">Тип проекта</h4>
                            <div class="filter-options">
                                <label class="filter-option">
                                    <input type="checkbox" name="type" value="Экспресс-лендинг" class="filter-checkbox" />
                                    <span class="filter-label">Экспресс-лендинг</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" name="type" value="Полноценный сайт" class="filter-checkbox" />
                                    <span class="filter-label">Полноценный сайт</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" name="type" value="Интернет-магазин" class="filter-checkbox" />
                                    <span class="filter-label">Интернет-магазин</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" name="type" value="Корпоративная платформа" class="filter-checkbox" />
                                    <span class="filter-label">Корпоративная платформа</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" name="type" value="Сайт + Продвижение" class="filter-checkbox" />
                                    <span class="filter-label">Сайт + Продвижение</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <h4 class="filter-group__title">Категория</h4>
                            <div class="filter-options">
                                <label class="filter-option">
                                    <input type="checkbox" name="category" value="Личный" class="filter-checkbox" />
                                    <span class="filter-label">Личный</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" name="category" value="Заказной" class="filter-checkbox" />
                                    <span class="filter-label">Заказной</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <h4 class="filter-group__title">Технологии</h4>
                            <div class="filter-options">
                                {filteredTechnologies.map(tech => (
                                    <label class="filter-option">
                                        <input type="checkbox" name="technology" value={tech} class="filter-checkbox" />
                                        <span class="filter-label">{tech}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-results">
                        <span id="resultsCount">{sortedProjects.length}</span> проектов
                    </div>
                </div>
            </aside>
        </div>
    </main>
</BaseLayout>

<script>
    const projectItems = document.querySelectorAll('.project-item');
    const checkboxes = document.querySelectorAll('.filter-checkbox');
    const resetButton = document.getElementById('resetFilters');
    const resultsCount = document.getElementById('resultsCount');
    
    function filterProjects() {
        const selectedTypes = Array.from(document.querySelectorAll('input[name="type"]:checked')).map(cb => (cb as HTMLInputElement).value);
        const selectedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked')).map(cb => (cb as HTMLInputElement).value);
        const selectedTech = Array.from(document.querySelectorAll('input[name="technology"]:checked')).map(cb => (cb as HTMLInputElement).value);
        
        let visibleCount = 0;
        
        projectItems.forEach(item => {
            const htmlItem = item as HTMLElement;
            const type = htmlItem.getAttribute('data-type') || '';
            const client = htmlItem.getAttribute('data-client') || '';
            const tech = htmlItem.getAttribute('data-tech')?.split(',') || [];
            
            // Проверяем тип проекта (частичное совпадение)
            const typeMatch = selectedTypes.length === 0 || selectedTypes.some(t => type.toLowerCase().includes(t.toLowerCase()));
            const clientMatch = selectedCategories.length === 0 || selectedCategories.some(c => client.toLowerCase().includes(c.toLowerCase()));
            const techMatch = selectedTech.length === 0 || selectedTech.some(t => tech.includes(t));
            
            if (typeMatch && clientMatch && techMatch) {
                htmlItem.style.display = '';
                visibleCount++;
            } else {
                htmlItem.style.display = 'none';
            }
        });
        
        if (resultsCount) {
            resultsCount.textContent = String(visibleCount);
        }
    }
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', filterProjects);
    });
    
    if (resetButton) {
        resetButton.addEventListener('click', () => {
            checkboxes.forEach(cb => (cb as HTMLInputElement).checked = false);
            filterProjects();
        });
    }
</script>
