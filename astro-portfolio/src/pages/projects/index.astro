---
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';

export const prerender = true;
const projects = await getCollection('projects');
const sortedProjects = projects.sort((a, b) => {
    const orderA = a.data.order || 999;
    const orderB = b.data.order || 999;
    return orderA - orderB;
});

// –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏
const categories = [...new Set(projects.map(p => p.data.projectLabel))];
const allTech = projects.flatMap(p => p.data.techStack.map(t => t.name));
const technologies = [...new Set(allTech)].sort();

// –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∫—Ä—É–ø–Ω—ã–µ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∏ –∏ —è–∑—ã–∫–∏
const majorTech = ['Laravel', 'Go', 'Next.js', 'React', 'Vue.js', 'Node.js', 'TypeScript', 'JavaScript', 'Python', 'PHP', 'Astro', 'Nuxt', 'Angular', 'Svelte', 'Django', 'FastAPI'];
const filteredTechnologies = technologies.filter(tech => 
    majorTech.some(major => tech.toLowerCase().includes(major.toLowerCase()))
).sort();
---

<BaseLayout 
    title="–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã ‚Äî –ê–Ω—Ç–æ–Ω –î–≤–∏–Ω—è–Ω–∏–Ω–æ–≤"
    description="–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ –ø—Ä–æ–µ–∫—Ç–æ–≤: –≤–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞, UI/UX –¥–∏–∑–∞–π–Ω, SaaS-–ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –∏ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
>
    <!-- Inline –∫—Ä–∏—Ç–∏—á–Ω—ã–π CSS –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ–µ–∫—Ç–æ–≤ -->
    <style slot="head">
        .projects-page{min-height:100vh;padding-top:100px}
        .projects-hero{padding:60px 60px 80px}
        .projects-container{display:flex;gap:60px;padding-right:60px}
        .projects-sidebar{width:380px;flex-shrink:0}
        .projects-grid-section{padding:0 0 120px 60px;flex:1;min-width:0}
        .projects-list{display:flex;flex-direction:column;gap:0}
        .project-item{border-bottom:1px solid var(--border);transition:all .3s ease;border-radius:20px}
        .project-item__link{display:grid;grid-template-columns:180px 1fr 60px;align-items:center;gap:40px;padding:35px 0;text-decoration:none;color:inherit}
        .project-item__image{width:180px;height:180px;display:flex;align-items:center;justify-content:center;background:var(--card-bg);border-radius:24px;border:1px solid var(--border);overflow:hidden}
        @media(max-width:768px){
            .projects-sidebar{display:none}
            .projects-grid-section{padding:0 20px 60px}
        }
    </style>
    <link slot="head" rel="stylesheet" href="/styles/projects.css?v=3" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="/styles/projects.css?v=3"></noscript>
    <script slot="head">
        console.log('üé® Projects CSS version: v=3');
        console.log('üìÅ CSS URL:', '/styles/projects.css?v=3');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏
        window.addEventListener('load', () => {
            const link = document.querySelector('link[href*="projects.css"]');
            if (link) {
                console.log('‚úÖ Projects CSS loaded:', link.href);
            } else {
                console.error('‚ùå Projects CSS not found!');
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º flex-direction
            const container = document.querySelector('.projects-container');
            if (container) {
                const styles = window.getComputedStyle(container);
                console.log('üìê Container flex-direction:', styles.flexDirection);
                console.log('üìê Container display:', styles.display);
            }
        });
    </script>
    <Header />
    
    <main class="projects-page">
        <div class="projects-hero">
            <a href="/" class="back-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                <span>–ù–∞ –≥–ª–∞–≤–Ω—É—é</span>
            </a>
            
            <div class="projects-hero__content">
                <span class="projects-hero__label">–ü–æ—Ä—Ç—Ñ–æ–ª–∏–æ</span>
                <h1 class="projects-hero__title">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</h1>
                <p class="projects-hero__desc">
                    –í–µ–±-—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞, UI/UX –¥–∏–∑–∞–π–Ω –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Ü–∏—Ñ—Ä–æ–≤—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
                </p>
            </div>
        </div>
        
        <div class="projects-container">
            <section class="projects-grid-section">
                <div class="projects-list" id="projectsList">
                    {sortedProjects.map((project, index) => (
                        <article class="project-item" data-type={project.data.projectType} data-category={project.data.projectLabel} data-client={project.data.projectClient} data-year={project.data.projectYear} data-tech={project.data.techStack.map(t => t.name).join(',')}>
                            <a href={`/projects/${project.slug}/`} class="project-item__link">
                                <div class="project-item__image">
                                    {project.data.projectImage ? (
                                        <Image 
                                            src={project.data.projectImage} 
                                            alt={project.data.projectName} 
                                            class="project-item__photo"
                                            loading={index === 0 ? "eager" : "lazy"}
                                            decoding="async"
                                            width={370}
                                            height={370}
                                            quality={80}
                                            format="webp"
                                        />
                                    ) : project.data.projectLogo ? (
                                        <Image 
                                            src={project.data.projectLogo} 
                                            alt={`${project.data.projectName} logo`} 
                                            class="project-item__logo"
                                            loading={index === 0 ? "eager" : "lazy"}
                                            decoding="async"
                                            width={370}
                                            height={370}
                                            quality={80}
                                            format="webp"
                                        />
                                    ) : (
                                        <div class="project-item__placeholder">
                                            {project.data.projectName.charAt(0)}
                                        </div>
                                    )}
                                </div>
                                
                                <div class="project-item__content">
                                    <div class="project-item__header">
                                        <h2 class="project-item__title">{project.data.projectName}</h2>
                                        <span class="project-item__label">{project.data.projectLabel}</span>
                                    </div>
                                    <p class="project-item__desc">{project.data.projectDesc}</p>
                                    <div class="project-item__tech">
                                        {project.data.techStack.slice(0, 6).map(tech => (
                                            <img src={tech.icon} alt={tech.name} class="tech-icon" title={tech.name} />
                                        ))}
                                        {project.data.techStack.length > 6 && (
                                            <span class="tech-more">+{project.data.techStack.length - 6}</span>
                                        )}
                                    </div>
                                </div>
                                
                                <div class="project-item__arrow">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M5 12h14M12 5l7 7-7 7"/>
                                    </svg>
                                </div>
                            </a>
                        </article>
                    ))}
                </div>
            </section>
            
            <aside class="projects-sidebar">
                <div class="projects-sidebar__sticky">
                    <div class="filter-card">
                        <div class="filter-card__header">
                            <h3 class="filter-card__title">–§–∏–ª—å—Ç—Ä—ã</h3>
                            <button class="filter-reset" id="resetFilters">–°–±—Ä–æ—Å–∏—Ç—å</button>
                        </div>
                        
                        <div class="filter-group">
                            <h4 class="filter-group__title">–¢–∏–ø –ø—Ä–æ–µ–∫—Ç–∞</h4>
                            <div class="filter-options">
                                <label class="filter-option">
                                    <input type="checkbox" name="type" value="–≠–∫—Å–ø—Ä–µ—Å—Å-–ª–µ–Ω–¥–∏–Ω–≥" class="filter-checkbox" />
                                    <span class="filter-label">–≠–∫—Å–ø—Ä–µ—Å—Å-–ª–µ–Ω–¥–∏–Ω–≥</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" name="type" value="–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Å–∞–π—Ç" class="filter-checkbox" />
                                    <span class="filter-label">–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π —Å–∞–π—Ç</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" name="type" value="–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω" class="filter-checkbox" />
                                    <span class="filter-label">–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" name="type" value="–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞" class="filter-checkbox" />
                                    <span class="filter-label">–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" name="type" value="–°–∞–π—Ç + –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ" class="filter-checkbox" />
                                    <span class="filter-label">–°–∞–π—Ç + –ü—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <h4 class="filter-group__title">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</h4>
                            <div class="filter-options">
                                <label class="filter-option">
                                    <input type="checkbox" name="category" value="–õ–∏—á–Ω—ã–π" class="filter-checkbox" />
                                    <span class="filter-label">–õ–∏—á–Ω—ã–π</span>
                                </label>
                                <label class="filter-option">
                                    <input type="checkbox" name="category" value="–ó–∞–∫–∞–∑–Ω–æ–π" class="filter-checkbox" />
                                    <span class="filter-label">–ó–∞–∫–∞–∑–Ω–æ–π</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <h4 class="filter-group__title">–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏</h4>
                            <div class="filter-options">
                                {filteredTechnologies.map(tech => (
                                    <label class="filter-option">
                                        <input type="checkbox" name="technology" value={tech} class="filter-checkbox" />
                                        <span class="filter-label">{tech}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                    </div>
                    
                    <div class="filter-results">
                        <span id="resultsCount">{sortedProjects.length}</span> –ø—Ä–æ–µ–∫—Ç–æ–≤
                    </div>
                </div>
            </aside>
        </div>
    </main>
</BaseLayout>

<script>
    const projectItems = document.querySelectorAll('.project-item');
    const checkboxes = document.querySelectorAll('.filter-checkbox');
    const resetButton = document.getElementById('resetFilters');
    const resultsCount = document.getElementById('resultsCount');
    
    function filterProjects() {
        const selectedTypes = Array.from(document.querySelectorAll('input[name="type"]:checked')).map(cb => (cb as HTMLInputElement).value);
        const selectedCategories = Array.from(document.querySelectorAll('input[name="category"]:checked')).map(cb => (cb as HTMLInputElement).value);
        const selectedTech = Array.from(document.querySelectorAll('input[name="technology"]:checked')).map(cb => (cb as HTMLInputElement).value);
        
        let visibleCount = 0;
        
        projectItems.forEach(item => {
            const htmlItem = item as HTMLElement;
            const type = htmlItem.getAttribute('data-type') || '';
            const client = htmlItem.getAttribute('data-client') || '';
            const tech = htmlItem.getAttribute('data-tech')?.split(',') || [];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –ø—Ä–æ–µ–∫—Ç–∞ (—á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ)
            const typeMatch = selectedTypes.length === 0 || selectedTypes.some(t => type.toLowerCase().includes(t.toLowerCase()));
            const clientMatch = selectedCategories.length === 0 || selectedCategories.some(c => client.toLowerCase().includes(c.toLowerCase()));
            const techMatch = selectedTech.length === 0 || selectedTech.some(t => tech.includes(t));
            
            if (typeMatch && clientMatch && techMatch) {
                htmlItem.style.display = '';
                visibleCount++;
            } else {
                htmlItem.style.display = 'none';
            }
        });
        
        if (resultsCount) {
            resultsCount.textContent = String(visibleCount);
        }
    }
    
    checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', filterProjects);
    });
    
    if (resetButton) {
        resetButton.addEventListener('click', () => {
            checkboxes.forEach(cb => (cb as HTMLInputElement).checked = false);
            filterProjects();
        });
    }
</script>
